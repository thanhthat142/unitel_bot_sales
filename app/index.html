<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatBot Widget</title>
    <!-- Tailwind CSS -->
    <script src="../js/tailwind.js"></script>
    <!-- FontAwesome CSS -->
    <link rel="stylesheet" href="../asset/icons/fontawesome/css/all.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../css/style.css">
    <!-- jQuery -->
    <script src="../js/jquery.js"></script>
    <style>        
    
    .chat-widget-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 999999;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }
        
        .chat-bubble {
            animation: bounce-in 0.3s ease-out;
        }
        
        @keyframes bounce-in {
            0% { transform: scale(0.8) translateY(20px); opacity: 0; }
            50% { transform: scale(1.05); }
            100% { transform: scale(1) translateY(0); opacity: 1; }
        }
        
        .slide-up {
            animation: slide-up 0.3s ease-out;
        }
        
        @keyframes slide-up {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .chat-scroll::-webkit-scrollbar {
            width: 4px;
        }
        
        .chat-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 2px;
        }
        
        .chat-scroll::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 2px;
        }
        
        .chat-scroll::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
        
        .typing-dot {
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        
        /* Custom scrollbar for textarea */
        #messageInput::-webkit-scrollbar {
            width: 4px;
        }
        
        #messageInput::-webkit-scrollbar-track {
            background: transparent;
        }
        
        #messageInput::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 2px;
        }
        
        #messageInput::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
        
        /* Hide scrollbar for Firefox */
        #messageInput {
            scrollbar-width: thin;
            scrollbar-color: #d1d5db transparent;
        }
        
        @media (max-width: 640px) {
            .chat-widget-container {
                bottom: 10px;
                right: 10px;
            }
        }
    </style>
</head>
<body>    <!-- Chat Widget Container - Fixed Position -->
    <div id="chatWidget" class="chat-widget-container">        
        <!-- Chat Window (Hidden by default) -->
        <div id="chatWindow" class="hidden slide-up bg-white rounded-2xl shadow-2xl overflow-hidden w-80 sm:w-[450px] h-[580px] mb-4 flex flex-col">
            <!-- Chat Header -->
            <div class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-4 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center animate-pulse">
                        <i class="fas fa-robot text-white text-lg"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg">Tr·ª£ l√Ω AI Unitel</h3>
                        <p class="text-blue-100 text-sm flex items-center">
                            <span class="w-2 h-2 bg-green-400 rounded-full mr-2 animate-pulse"></span>
                            S·∫µn s√†ng h·ªó tr·ª£
                        </p>
                    </div>
                </div>
                <div class="flex space-x-1">
                    <button id="minimizeChat" class="p-2 hover:bg-white hover:bg-opacity-20 rounded-full transition-all duration-200 transform hover:scale-110">
                        <i class="fas fa-minus text-white text-sm"></i>
                    </button>
                    <button id="closeChat" class="p-2 hover:bg-white hover:bg-opacity-20 rounded-full transition-all duration-200 transform hover:scale-110">
                        <i class="fas fa-times text-white text-sm"></i>
                    </button>
                </div>
            </div>            
            <!-- Chat Messages -->
            <div id="chatContainer" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gradient-to-b from-gray-50 to-white chat-scroll min-h-0">
                <!-- Welcome Message -->
                <div class="flex items-start space-x-3 slide-up">                    
                    <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-full flex items-center justify-center flex-shrink-0 shadow-md">
                        <i class="fas fa-robot text-white text-xs"></i>
                    </div>                    
                    <div class="bg-white p-4 rounded-2xl rounded-tl-sm shadow-sm max-w-[300px] border border-gray-100">
                        <p class="text-gray-800 text-sm leading-relaxed">üëã Ch√†o b·∫°n! M√¨nh l√† tr·ª£ l√Ω AI c·ªßa Unitel. T√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n h√¥m nay?</p>
                        <span class="text-xs text-gray-400 mt-2 block">V·ª´a xong</span>
                    </div>
                </div>
            </div>            
            <!-- Typing Indicator (Hidden by default) -->
            <div id="typingIndicator" class="flex-shrink-0 px-4 pb-2 bg-gradient-to-b from-gray-50 to-white hidden">
                <div class="flex items-start space-x-3">
                    <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-full flex items-center justify-center shadow-md">
                        <i class="fas fa-robot text-white text-xs"></i>
                    </div>
                    <div class="bg-white p-4 rounded-2xl rounded-tl-sm shadow-sm border border-gray-100">
                        <div class="flex space-x-1">
                            <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                        </div>
                    </div>
                </div>
            </div>            
            <!-- Chat Input -->
            <div class="flex-shrink-0 p-4 bg-white border-t border-gray-200">
                <div class="flex items-end space-x-3">                    
                    <!-- Message Input -->
                    <div class="flex-1 relative">                        
                        <textarea 
                            id="messageInput" 
                            placeholder="Nh·∫≠p tin nh·∫Øn c·ªßa b·∫°n..." 
                            class="w-full p-3 pr-14 border border-gray-300 rounded-2xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none transition-all duration-200 min-h-[44px] max-h-[120px]"
                            maxlength="500"
                            rows="1"
                        ></textarea>
                        <!-- Emoji Button -->
                        <button id="emojiButton" class="absolute right-3 bottom-3 text-gray-400 hover:text-gray-600 transition-colors">
                            <i class="fas fa-smile"></i>
                        </button>
                    </div>
                    
                    <!-- Send Button -->
                    <button id="sendButton" class="p-3 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-2xl hover:from-blue-600 hover:to-indigo-700 transition-all duration-200 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg">
                        <i class="fas fa-paper-plane text-sm"></i>
                    </button>
                </div>
                
                <!-- Quick Actions -->
                <div class="flex flex-wrap gap-2 mt-3">
                    <button class="quick-action px-3 py-1.5 bg-gray-100 text-gray-700 rounded-full text-xs hover:bg-gray-200 transition-all duration-200 transform hover:scale-105">
                        <i class="fas fa-question-circle mr-1"></i>
                        H·ªó tr·ª£
                    </button>
                    <button class="quick-action px-3 py-1.5 bg-gray-100 text-gray-700 rounded-full text-xs hover:bg-gray-200 transition-all duration-200 transform hover:scale-105">
                        <i class="fas fa-shopping-cart mr-1"></i>
                        S·∫£n ph·∫©m
                    </button>
                    <button class="quick-action px-3 py-1.5 bg-gray-100 text-gray-700 rounded-full text-xs hover:bg-gray-200 transition-all duration-200 transform hover:scale-105">
                        <i class="fas fa-phone mr-1"></i>
                        Li√™n h·ªá
                    </button>
                </div>
            </div>
        </div>        
        <!-- Floating Chat Button -->
        <button id="chatToggle" class="chat-bubble w-16 h-16 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-full shadow-2xl hover:shadow-3xl transform hover:scale-110 transition-all duration-300 relative overflow-hidden">
            <div class="absolute inset-0 bg-gradient-to-r from-blue-600 to-indigo-700 opacity-0 hover:opacity-100 transition-opacity duration-300"></div>
            <i id="chatIcon" class="fas fa-comments text-xl relative z-10"></i>
            <!-- Notification Badge -->
            <span id="notificationBadge" class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white text-xs rounded-full flex items-center justify-center font-bold shadow-lg animate-pulse hidden">1</span>
        </button>
    </div>

    <!-- JavaScript for Chat Functionality -->
    <script>
        class ChatWidget {
            constructor() {
                this.isOpen = false;
                this.messageCount = 0;
                this.init();
            }

            init() {
                this.bindEvents();
                //this.showWelcomeMessage();
            }            
            
            bindEvents() {
                // Toggle chat window
                $('#chatToggle').click(() => this.toggleChat());
                
                // Close/minimize chat
                $('#closeChat, #minimizeChat').click(() => this.closeChat());
                
                // Send message
                $('#sendButton').click(() => this.sendMessage());
                $('#messageInput').on('keypress', (e) => {
                    if (e.which === 13 && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                // Auto-resize textarea
                $('#messageInput').on('input', () => {
                    this.autoResizeTextarea();
                    const message = $('#messageInput').val().trim();
                    $('#sendButton').prop('disabled', message === '');
                });

                // Quick actions
                $('.quick-action').click((e) => {
                    const action = $(e.currentTarget).text().trim();
                    this.sendQuickAction(action);
                });
            }

            toggleChat() {
                if (this.isOpen) {
                    this.closeChat();
                } else {
                    this.openChat();
                }
            }

            openChat() {
                $('#chatWindow').removeClass('hidden').addClass('slide-up');
                $('#chatIcon').removeClass('fa-comments').addClass('fa-times');
                $('#notificationBadge').addClass('hidden');
                this.isOpen = true;
                
                // Focus on input
                setTimeout(() => {
                    $('#messageInput').focus();
                }, 300);

                // Auto scroll to bottom
                this.scrollToBottom();
            }

            closeChat() {
                $('#chatWindow').addClass('hidden').removeClass('slide-up');
                $('#chatIcon').removeClass('fa-times').addClass('fa-comments');
                this.isOpen = false;
                
                // Show notification if there are unread messages
                if (this.messageCount > 0) {
                    $('#notificationBadge').removeClass('hidden');
                }
            }            
            
            sendMessage() {
                const message = $('#messageInput').val().trim();
                if (message === '') return;

                this.addUserMessage(message);
                $('#messageInput').val('').prop('disabled', true);
                $('#sendButton').prop('disabled', true);
                
                // Reset textarea height
                this.resetTextareaHeight();
                
                this.showTypingIndicator();
                this.simulateBotResponse(message);
            }

            autoResizeTextarea() {
                const textarea = $('#messageInput')[0];
                if (!textarea) return;
                
                // Reset height to auto to get the correct scrollHeight
                textarea.style.height = 'auto';
                
                // Set height based on scrollHeight, with min and max constraints
                const minHeight = 44; // min-h-[44px]
                const maxHeight = 120; // max-h-[120px]
                const scrollHeight = textarea.scrollHeight;
                
                if (scrollHeight <= maxHeight) {
                    textarea.style.height = Math.max(minHeight, scrollHeight) + 'px';
                } else {
                    textarea.style.height = maxHeight + 'px';
                }
            }

            resetTextareaHeight() {
                const textarea = $('#messageInput')[0];
                if (textarea) {
                    textarea.style.height = '44px'; // Reset to min height
                }
            }

            sendQuickAction(action) {
                const actionMessages = {
                    'H·ªó tr·ª£': 'T√¥i c·∫ßn h·ªó tr·ª£',
                    'D·ªãch v·ª•': 'T√¥i mu·ªën t√¨m hi·ªÉu v·ªÅ d·ªãch v·ª•',
                    'Li√™n h·ªá': 'T√¥i mu·ªën li√™n h·ªá v·ªõi b·ªô ph·∫≠n h·ªó tr·ª£'
                };
                
                const message = actionMessages[action] || action;
                $('#messageInput').val(message);
                this.sendMessage();
            }

            addUserMessage(message) {
                const time = this.getCurrentTime();
                const userMessage = `
                    <div class="flex items-start space-x-3 justify-end slide-up">
                        <div class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white p-4 rounded-2xl rounded-tr-sm shadow-md max-w-[300px]">
                            <p class="text-sm leading-relaxed break-words">${this.escapeHtml(message)}</p>
                            <span class="text-xs text-blue-100 mt-2 block">${time}</span>
                        </div>
                        <div class="w-8 h-8 bg-gradient-to-r from-gray-400 to-gray-500 rounded-full flex items-center justify-center flex-shrink-0 shadow-md">
                            <i class="fas fa-user text-white text-xs"></i>
                        </div>
                    </div>
                `;
                
                $('#chatContainer').append(userMessage);
                this.scrollToBottom();
            }

            addBotMessage(message) {
                const time = this.getCurrentTime();
                let text = typeof message === 'string' ? message : (message?.text || '');
                let lang = typeof message === 'object' ? message.lang : null;

                // T·ª± ƒë·ªông nh·∫≠n di·ªán ng√¥n ng·ªØ n·∫øu ch∆∞a c√≥
                function detectLang(text) {
                    if (/[‡∫Å-‡ªù]/.test(text)) return "lo"; 
                    if (/[a-zA-Z]/.test(text) && /you|how|help|please/i.test(text)) return "en";
                    return "vi";
                }
                if (!lang || lang === "vi") {
                    lang = detectLang(text);
                }

                // Ki·ªÉm tra c√≥ link ƒëƒÉng k√Ω kh√¥ng, n·∫øu c√≥ th√¨ t√°ch link ra kh·ªèi n·ªôi dung ch√≠nh
                const hasLink = text.includes("https://look.tnet.vn/register-package");
                const cleanText = text
                    .replace("https://look.tnet.vn/register-package", "")
                    .replace(/\[\]\(https:\/\/look\.tnet\.vn\/register-package\)/g, "")
                    .replace(/\[.*?\]\(https:\/\/look\.tnet\.vn\/register-package\)/g, "")
                    .trim();

                // Format l·∫°i n·ªôi dung: xu·ªëng d√≤ng, in ƒë·∫≠m
                const formattedText = cleanText
                    .replace(/ - /g, "<br>")
                    .replace(/\n/g, "<br>")
                    .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");

                // T·∫°o kh·ªëi tin nh·∫Øn bot
                const botMessage = `
                    <div class="flex items-start space-x-3 slide-up">
                        <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-full flex items-center justify-center flex-shrink-0 shadow-md">
                            <i class="fas fa-robot text-white text-xs"></i>
                        </div>
                        <div class="bg-white p-4 rounded-2xl rounded-tl-sm shadow-sm max-w-[300px] border border-gray-100">
                            <p class="text-gray-800 text-sm leading-relaxed break-words">${formattedText}</p>
                            <span class="text-xs text-gray-400 mt-2 block">${time}</span>
                        </div>
                    </div>
                `;
                $('#chatContainer').append(botMessage);

                // N·∫øu c√≥ link, th√™m n√∫t ƒëƒÉng k√Ω b√™n d∆∞·ªõi
                if (hasLink) {
                    const buttonLabels = {
                        vi: "ƒêƒÉng k√Ω ngay",
                        lo: "‡∫•‡∫ª‡∫á‡∫ó‡∫∞‡∫ö‡∫Ω‡∫ô",
                        en: "Register now"
                    };
                    const label = buttonLabels[lang] || buttonLabels.vi;
                    const buttonHtml = `
                        <div class="flex items-start space-x-3 slide-up">
                            <div class="w-8 h-8"></div>
                            <div>
                                <button onclick="window.open('https://look.tnet.vn/register-package', '_blank')"
                                    class="flex items-center gap-2 px-5 py-2 bg-gradient-to-r from-pink-500 to-red-500 hover:from-red-500 hover:to-pink-500 text-white font-semibold rounded-full shadow-lg transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-pink-400"
                                    style="margin: 10px 0 5px 0;">
                                    <i class="fas fa-paper-plane animate-pulse"></i>
                                    <span>${label}</span>
                                </button>
                            </div>
                        </div>
                    `;
                    $('#chatContainer').append(buttonHtml);
                }

                this.scrollToBottom();

                if (!this.isOpen) {
                    this.messageCount++;
                    $('#notificationBadge').text(this.messageCount).removeClass('hidden');
                }
            }

            showTypingIndicator() {
                $('#typingIndicator').removeClass('hidden');
                this.scrollToBottom();
            }

            hideTypingIndicator() {
                $('#typingIndicator').addClass('hidden');
            }

            simulateBotResponse(userMessage) {
                fetch('https://408b-14-231-188-210.ngrok-free.app/webhook/get', {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "ngrok-skip-browser-warning": "true"
                    },
                    body: JSON.stringify({ message: userMessage }),
                })
                .then(async response => {
                    const contentType = response.headers.get("content-type");
                    const raw = await response.text();
                    this.hideTypingIndicator();
                    if (contentType && contentType.includes("application/json")) {
                        const data = JSON.parse(raw);
                        const reply = data[0]?.response || data[0]?.text || data[0]?.message || "Kh√¥ng c√≥ ph·∫£n h·ªìi t·ª´ m√°y ch·ªß.";
                        this.addBotMessage(this.escapeHtml(reply));
                    } else {
                        this.addBotMessage("Ph·∫£n h·ªìi kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng JSON.");
                    }
                    $('#messageInput').prop('disabled', false);
                    $('#sendButton').prop('disabled', false);
                    $('#messageInput').focus();
                })
                .catch(error => {
                    this.hideTypingIndicator();
                    this.addBotMessage("ƒê√£ x·∫£y ra l·ªói k·∫øt n·ªëi.");
                    $('#messageInput').prop('disabled', false);
                    $('#sendButton').prop('disabled', false);
                    $('#messageInput').focus();
                });
            }

            showWelcomeMessage() {
                setTimeout(() => {
                    if (!this.isOpen) {
                        this.addBotMessage("üëã Ch√†o b·∫°n! T√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n?");
                    }
                }, 2000);
            }

            scrollToBottom() {
                const container = $('#chatContainer')[0];
                if (container) {
                    container.scrollTop = container.scrollHeight;
                }
            }

            getCurrentTime() {
                return new Date().toLocaleTimeString('vi-VN', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // Initialize chat widget when document is ready
        $(document).ready(function() {
            window.chatWidget = new ChatWidget();
        });
    </script>
</body>
</html>
